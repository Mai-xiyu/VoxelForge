# ───────────────────────────────────────────────────────────
# VoxelForge — 多平台发布 (Nuitka)
#
# 触发: 推送 v* tag 或手动 workflow_dispatch
# 产物: Windows .exe / macOS .app(.dmg) / Linux AppImage + .deb
# ───────────────────────────────────────────────────────────
name: Release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      version:
        description: "Release version (e.g. 0.2.0)"
        required: false
        default: "0.0.0-dev"

permissions:
  contents: write

env:
  PYTHON_VERSION: "3.11"
  APP_NAME: VoxelForge
  ENTRY: main.py

jobs:
  # ── Windows ─────────────────────────────────────────────
  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install nuitka ordered-set zstandard

      - name: Build with Nuitka
        run: |
          python -m nuitka ^
            --standalone ^
            --onefile ^
            --assume-yes-for-downloads ^
            --enable-plugin=pyside6 ^
            --windows-icon-from-ico=gui/resources/icons/favicon.ico ^
            --windows-company-name=VoxelForge ^
            --windows-product-name=VoxelForge ^
            --windows-file-version=0.1.0.0 ^
            --windows-product-version=0.1.0.0 ^
            --include-data-dir=config=config ^
            --include-data-dir=i18n/locales=i18n/locales ^
            --include-data-dir=gui/resources=gui/resources ^
            --include-data-dir=gui/web=gui/web ^
            --include-data-dir=gui/web_panels/html=gui/web_panels/html ^
            --include-data-dir=gui/web_panels/js=gui/web_panels/js ^
            --output-filename=VoxelForge.exe ^
            --output-dir=dist ^
            ${{ env.ENTRY }}
        shell: cmd

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: VoxelForge-Windows-x64
          path: dist/VoxelForge.exe
          retention-days: 30

  # ── macOS ───────────────────────────────────────────────
  build-macos:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install nuitka ordered-set imageio

      - name: Convert PNG icon to ICNS
        run: |
          mkdir -p icon.iconset
          sips -z 16 16     gui/resources/icons/logo.png --out icon.iconset/icon_16x16.png
          sips -z 32 32     gui/resources/icons/logo.png --out icon.iconset/icon_16x16@2x.png
          sips -z 32 32     gui/resources/icons/logo.png --out icon.iconset/icon_32x32.png
          sips -z 64 64     gui/resources/icons/logo.png --out icon.iconset/icon_32x32@2x.png
          sips -z 128 128   gui/resources/icons/logo.png --out icon.iconset/icon_128x128.png
          sips -z 256 256   gui/resources/icons/logo.png --out icon.iconset/icon_128x128@2x.png
          sips -z 256 256   gui/resources/icons/logo.png --out icon.iconset/icon_256x256.png
          sips -z 512 512   gui/resources/icons/logo.png --out icon.iconset/icon_256x256@2x.png
          sips -z 512 512   gui/resources/icons/logo.png --out icon.iconset/icon_512x512.png
          sips -z 1024 1024 gui/resources/icons/logo.png --out icon.iconset/icon_512x512@2x.png
          iconutil -c icns icon.iconset -o gui/resources/icons/logo.icns

      - name: Build with Nuitka
        run: |
          python -m nuitka \
            --standalone \
            --assume-yes-for-downloads \
            --macos-create-app-bundle \
            --macos-app-icon=gui/resources/icons/logo.icns \
            --macos-app-name=VoxelForge \
            --enable-plugin=pyside6 \
            --include-data-dir=config=config \
            --include-data-dir=i18n/locales=i18n/locales \
            --include-data-dir=gui/resources=gui/resources \
            --include-data-dir=gui/web=gui/web \
            --include-data-dir=gui/web_panels/html=gui/web_panels/html \
            --include-data-dir=gui/web_panels/js=gui/web_panels/js \
            --output-dir=dist \
            ${{ env.ENTRY }}

      - name: Create DMG
        run: |
          brew install create-dmg || true
          create-dmg \
            --volname "VoxelForge" \
            --window-pos 200 120 \
            --window-size 600 400 \
            --icon-size 100 \
            --app-drop-link 450 185 \
            dist/VoxelForge.dmg \
            dist/main.app/ 2>/dev/null || \
          hdiutil create -volname VoxelForge -srcfolder dist/main.app -ov -format UDZO dist/VoxelForge.dmg

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: VoxelForge-macOS
          path: dist/VoxelForge.dmg
          retention-days: 30

  # ── Linux ───────────────────────────────────────────────
  build-linux:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          sudo apt-get update
          # 必须安装系统级 cmake 和编译器，否则 pip 安装 rocksdb 时子进程找不到环境
          sudo apt-get install -y \
            cmake build-essential \
            patchelf ccache libfuse2 \
            libxcb-xinerama0 libxkbcommon-x11-0 \
            libgl1-mesa-glx libegl1 \
            libxcb-cursor0 libxcb-icccm4 libxcb-keysyms1 \
            libxcb-shape0 libxcb-render-util0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install setuptools wheel pybind11
          
          # 修复补丁：针对 amulet-rocksdb 1.0.1 源码中错误的 CMake 4.1 版本检查
          # 1. 下载源码 2. 解压 3. 强制修改要求 4. 本地安装
          pip download amulet-rocksdb==1.0.1
          tar -xzvf amulet_rocksdb-1.0.1.tar.gz
          sed -i 's/cmake_minimum_required(VERSION 4.1)/cmake_minimum_required(VERSION 3.10)/g' amulet_rocksdb-1.0.1/CMakeLists.txt
          pip install ./amulet_rocksdb-1.0.1
          rm -rf amulet_rocksdb-1.0.1*
          
          # 安装剩余需求
          pip install -r requirements.txt
          pip install nuitka ordered-set

      - name: Build with Nuitka (standalone)
        run: |
          python -m nuitka \
            --standalone \
            --assume-yes-for-downloads \
            --enable-plugin=pyside6 \
            --linux-icon=gui/resources/icons/logo.png \
            --include-data-dir=config=config \
            --include-data-dir=i18n/locales=i18n/locales \
            --include-data-dir=gui/resources=gui/resources \
            --include-data-dir=gui/web=gui/web \
            --include-data-dir=gui/web_panels/html=gui/web_panels/html \
            --include-data-dir=gui/web_panels/js=gui/web_panels/js \
            --output-dir=dist \
            ${{ env.ENTRY }}

      - name: Create AppImage
        run: |
          wget -q "https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage" -O appimagetool
          chmod +x appimagetool
          mkdir -p AppDir/usr/bin AppDir/usr/share/icons/hicolor/256x256/apps AppDir/usr/share/applications
          cp -r dist/main.dist/* AppDir/usr/bin/
          cp gui/resources/icons/logo.png AppDir/usr/share/icons/hicolor/256x256/apps/voxelforge.png
          cp gui/resources/icons/logo.png AppDir/voxelforge.png
          cp packaging/voxelforge.desktop AppDir/voxelforge.desktop
          cp packaging/voxelforge.desktop AppDir/usr/share/applications/voxelforge.desktop
          cat > AppDir/AppRun << 'APPRUN'
          #!/bin/bash
          HERE="$(dirname "$(readlink -f "$0")")"
          exec "$HERE/usr/bin/main" "$@"
          APPRUN
          chmod +x AppDir/AppRun
          ARCH=x86_64 ./appimagetool AppDir dist/VoxelForge-x86_64.AppImage

      - name: Create .deb package
        run: |
          DEB_ROOT=deb_pkg
          mkdir -p $DEB_ROOT/DEBIAN $DEB_ROOT/usr/bin $DEB_ROOT/usr/share/applications $DEB_ROOT/usr/share/icons/hicolor/256x256/apps $DEB_ROOT/opt/voxelforge
          cp -r dist/main.dist/* $DEB_ROOT/opt/voxelforge/
          cat > $DEB_ROOT/usr/bin/voxelforge << 'LAUNCHER'
          #!/bin/bash
          exec /opt/voxelforge/main "$@"
          LAUNCHER
          chmod +x $DEB_ROOT/usr/bin/voxelforge
          cp packaging/voxelforge.desktop $DEB_ROOT/usr/share/applications/
          cp gui/resources/icons/logo.png $DEB_ROOT/usr/share/icons/hicolor/256x256/apps/voxelforge.png
          VERSION="${{ github.ref_name }}"
          VERSION="${VERSION#v}"
          [ -z "$VERSION" ] && VERSION="0.1.0"
          cat > $DEB_ROOT/DEBIAN/control << EOF
          Package: voxelforge
          Version: ${VERSION}
          Section: graphics
          Priority: optional
          Architecture: amd64
          Depends: libgl1, libegl1
          Maintainer: VoxelForge Team <noreply@voxelforge.dev>
          Description: 3D data to Minecraft block converter
          EOF
          dpkg-deb --build $DEB_ROOT dist/voxelforge_${VERSION}_amd64.deb

      - name: Upload AppImage
        uses: actions/upload-artifact@v4
        with:
          name: VoxelForge-Linux-AppImage
          path: dist/VoxelForge-x86_64.AppImage
          retention-days: 30

      - name: Upload .deb
        uses: actions/upload-artifact@v4
        with:
          name: VoxelForge-Linux-deb
          path: dist/voxelforge_*.deb
          retention-days: 30

  # ── GitHub Release ──────────────────────────────────────
  release:
    needs: [build-windows, build-macos, build-linux]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: "VoxelForge ${{ github.ref_name }}"
          body: |
            ## VoxelForge ${{ github.ref_name }}
            ### Downloads
            | Platform | File |
